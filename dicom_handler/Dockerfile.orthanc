FROM osimis/orthanc:22.10.2

USER root

RUN apt-get update && apt-get install -y \
    lua5.4 \
    lua5.4-dev \
    luarocks \
    build-essential \
 && apt-get clean && rm -rf /var/lib/apt/lists/*

RUN luarocks install luasocket

# Copy Lua modules from where luarocks installs them to Orthanc lua folder
RUN mkdir -p /etc/orthanc/lua && \
    cp -r /usr/share/lua/5.4/socket /etc/orthanc/lua/ && \
    cp /usr/share/lua/5.4/ltn12.lua /etc/orthanc/lua/ && \
    cp /usr/share/lua/5.4/mime.lua /etc/orthanc/lua/

# Make sure Orthanc Lua path includes /etc/orthanc/lua
ENV LUA_PATH="/etc/orthanc/lua/?.lua;;"
ENV LUA_CPATH="/usr/lib/lua/5.4/?.so;;"

USER orthanc
